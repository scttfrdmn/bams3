/*
 * BAMS3 Pipeline Configuration
 *
 * Profiles:
 *   - standard: Local execution
 *   - aws: AWS Batch execution
 *   - slurm: HPC cluster with SLURM
 */

// Manifest
manifest {
    name = 'BAMS3 Reference Pipeline'
    author = 'BAMS3 Project'
    description = 'Cloud-native genomics pipeline using BAMS3 format'
    version = '1.0.0'
    nextflowVersion = '>=22.0.0'
}

// Global parameters
params {
    // Input/Output
    samples = null
    reference = null
    output_dir = "s3://genomics-data/results"

    // Execution
    max_cpus = 32
    max_memory = '128.GB'
    max_time = '48.h'
}

// Process defaults
process {
    errorStrategy = 'retry'
    maxRetries = 2

    // Container for all processes
    container = 'scttfrdmn/bams3:latest'

    // Resource labels
    withLabel: 'low_cpu' {
        cpus = 2
        memory = '4.GB'
        time = '2.h'
    }

    withLabel: 'medium_cpu' {
        cpus = 8
        memory = '16.GB'
        time = '8.h'
    }

    withLabel: 'high_cpu' {
        cpus = 16
        memory = '32.GB'
        time = '24.h'
    }

    // Process-specific resources
    withName: 'INDEX_REFERENCE' {
        cpus = 1
        memory = '4.GB'
        time = '1.h'
    }

    withName: 'ALIGN_TO_BAMS3' {
        cpus = params.align_cpus
        memory = params.align_memory
        time = '12.h'
    }

    withName: 'CALL_VARIANTS_REGION' {
        cpus = params.vcall_cpus
        memory = params.vcall_memory
        time = '4.h'
    }
}

// Execution profiles
profiles {
    /*
     * Standard profile - Local execution
     */
    standard {
        process.executor = 'local'

        docker {
            enabled = false
        }

        params {
            max_cpus = 16
            max_memory = '64.GB'
        }
    }

    /*
     * AWS Batch profile - Cloud execution
     */
    aws {
        process {
            executor = 'awsbatch'
            queue = 'genomics-queue'

            // AWS-specific settings
            errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
            maxRetries = 3
        }

        aws {
            region = 'us-east-1'
            batch {
                cliPath = '/home/ec2-user/miniconda/bin/aws'
                maxTransferAttempts = 3
                maxParallelTransfers = 8
            }
        }

        docker {
            enabled = true
            registry = 'your-registry'
        }

        params {
            // S3 paths for cloud execution
            output_dir = 's3://genomics-data/results'
            bams3_dir = 's3://genomics-data/bams3'
            vcf_dir = 's3://genomics-data/vcf'
            qc_dir = 's3://genomics-data/qc'

            max_cpus = 96
            max_memory = '768.GB'
        }

        // Optimize for AWS
        workDir = 's3://genomics-data/work'

        process {
            // EC2 instance type selection by process
            withName: 'ALIGN_TO_BAMS3' {
                queue = 'genomics-high-cpu'
                // Optimized for alignment: c5.9xlarge (36 vCPU, 72 GB)
            }

            withName: 'CALL_VARIANTS_REGION' {
                queue = 'genomics-medium-mem'
                // Memory-optimized: r5.2xlarge (8 vCPU, 64 GB)
            }
        }
    }

    /*
     * SLURM profile - HPC cluster
     */
    slurm {
        process {
            executor = 'slurm'
            queue = 'genomics'
            clusterOptions = '--account=genomics_project'

            // SLURM-specific settings
            errorStrategy = 'retry'
            maxRetries = 2

            time = '24.h'
        }

        singularity {
            enabled = true
            autoMounts = true
            cacheDir = '/scratch/singularity'
        }

        params {
            max_cpus = 48
            max_memory = '384.GB'
        }

        process {
            withName: 'ALIGN_TO_BAMS3' {
                cpus = 32
                memory = '128.GB'
                time = '48.h'
            }
        }
    }

    /*
     * Testing profile - Quick validation
     */
    test {
        params {
            samples = "${projectDir}/test_data/samples.csv"
            reference = "${projectDir}/test_data/reference.fa"
            regions = "${projectDir}/test_data/regions.bed"
            output_dir = "test_results"

            align_cpus = 4
            align_memory = '8.GB'
            sort_buffer = '6G'
            vcall_cpus = 2
            vcall_memory = '4.GB'
        }
    }

    /*
     * Development profile - Debug mode
     */
    dev {
        process.errorStrategy = 'terminate'

        docker.enabled = false

        params {
            max_cpus = 8
            max_memory = '32.GB'
        }

        // Enable detailed trace
        trace {
            enabled = true
            file = 'trace.txt'
            fields = 'task_id,hash,native_id,name,status,exit,submit,duration,realtime,%cpu,rss'
        }

        timeline {
            enabled = true
            file = 'timeline.html'
        }

        report {
            enabled = true
            file = 'report.html'
        }
    }
}

// Reporting
report {
    enabled = true
    file = "${params.output_dir}/pipeline_report.html"
}

timeline {
    enabled = true
    file = "${params.output_dir}/execution_timeline.html"
}

trace {
    enabled = true
    file = "${params.output_dir}/execution_trace.txt"
    fields = 'task_id,hash,native_id,name,status,exit,submit,start,complete,duration,realtime,%cpu,%mem,rss,vmem,peak_rss,peak_vmem'
}

dag {
    enabled = true
    file = "${params.output_dir}/pipeline_dag.svg"
}

// Notifications
notification {
    enabled = false
    to = 'user@example.com'
}
